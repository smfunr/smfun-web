#!/usr/bin/env bash
set -u

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_FILE="$ROOT_DIR/.env"

pass_count=0
fail_count=0
warn_count=0

passes=()
fails=()
warns=()

pass() {
  pass_count=$((pass_count + 1))
  passes+=("$1")
  echo "âœ… PASS: $1"
}

fail() {
  fail_count=$((fail_count + 1))
  fails+=("$1")
  echo "âŒ FAIL: $1"
}

warn() {
  warn_count=$((warn_count + 1))
  warns+=("$1")
  echo "âš ï¸  WARN: $1"
}

get_env_value() {
  local key="$1"
  if [[ ! -f "$ENV_FILE" ]]; then
    echo ""
    return
  fi
  local line
  line=$(grep -E "^[[:space:]]*${key}=" "$ENV_FILE" | tail -n 1 || true)
  line="${line#*=}"
  # å»æ‰é¦–å°¾ç©ºç™½
  line="$(echo "$line" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
  # å»æ‰åŒ…è£¹å¼•å·
  line="${line%\"}"
  line="${line#\"}"
  line="${line%\'}"
  line="${line#\'}"
  echo "$line"
}

is_placeholder() {
  local v="$1"
  [[ -z "$v" || "$v" == "0xYOUR_PRIVATE_KEY" || "$v" == "YOUR_PRIVATE_KEY" ]]
}

echo "== ben | polymarket-bot å¯åŠ¨å‰è‡ªæ£€ =="

echo "[1/5] æ£€æŸ¥ .env ä¸å…³é”®é¡¹"
if [[ ! -f "$ENV_FILE" ]]; then
  fail ".env ä¸å­˜åœ¨ï¼ˆè¯·å…ˆä» .env.auto.example æˆ– .env.example å¤åˆ¶ï¼‰"
else
  pass ".env æ–‡ä»¶å­˜åœ¨"

  dry_run_val="$(get_env_value "DRY_RUN")"
  log_dir_val="$(get_env_value "LOG_DIR")"
  poly_pk_val="$(get_env_value "POLY_PRIVATE_KEY")"
  up_token_val="$(get_env_value "UP_TOKEN_ID")"
  down_token_val="$(get_env_value "DOWN_TOKEN_ID")"

  if [[ -z "$dry_run_val" ]]; then
    fail "DRY_RUN æœªé…ç½®"
  else
    pass "DRY_RUN å·²é…ç½®"
  fi

  if [[ -z "$log_dir_val" ]]; then
    fail "LOG_DIR æœªé…ç½®"
  else
    pass "LOG_DIR å·²é…ç½®"
  fi

  auto_ready=0
  manual_ready=0

  if is_placeholder "$poly_pk_val"; then
    warn "è‡ªåŠ¨ç‰ˆå…³é”®é¡¹ POLY_PRIVATE_KEY æœªå°±ç»ª"
  else
    auto_ready=1
    pass "è‡ªåŠ¨ç‰ˆå…³é”®é¡¹ POLY_PRIVATE_KEY å·²å°±ç»ª"
  fi

  if [[ -n "$up_token_val" && -n "$down_token_val" ]]; then
    manual_ready=1
    pass "æ‰‹åŠ¨ç‰ˆå…³é”®é¡¹ UP_TOKEN_ID / DOWN_TOKEN_ID å·²å°±ç»ª"
  else
    warn "æ‰‹åŠ¨ç‰ˆå…³é”®é¡¹ UP_TOKEN_ID / DOWN_TOKEN_ID æœªå°±ç»ª"
  fi

  if [[ $auto_ready -eq 0 && $manual_ready -eq 0 ]]; then
    fail ".env å…³é”®é¡¹ä¸å®Œæ•´ï¼šè‡³å°‘éœ€è¦å®Œæˆä¸€ç§æ¨¡å¼ï¼ˆè‡ªåŠ¨ç‰ˆæˆ–æ‰‹åŠ¨ç‰ˆï¼‰"
  else
    pass ".env å…³é”®é¡¹å®Œæ•´ï¼ˆè‡³å°‘ä¸€ç§è¿è¡Œæ¨¡å¼å¯ç”¨ï¼‰"
  fi
fi

echo

echo "[2/5] æ£€æŸ¥ LOG_DIR å¯å†™"
log_dir_effective="$(get_env_value "LOG_DIR")"
if [[ -z "$log_dir_effective" ]]; then
  log_dir_effective="$ROOT_DIR/logs"
fi

if [[ "$log_dir_effective" = /* ]]; then
  resolved_log_dir="$log_dir_effective"
else
  resolved_log_dir="$ROOT_DIR/$log_dir_effective"
fi

if mkdir -p "$resolved_log_dir" 2>/dev/null; then
  test_file="$resolved_log_dir/.ben_write_test_$$"
  if ( : > "$test_file" ) 2>/dev/null; then
    rm -f "$test_file"
    pass "LOG_DIR å¯å†™ï¼š$resolved_log_dir"
  else
    fail "LOG_DIR ä¸å¯å†™ï¼š$resolved_log_dir"
  fi
else
  fail "LOG_DIR æ— æ³•åˆ›å»ºï¼š$resolved_log_dir"
fi

echo

echo "[3/5] æ˜¾å¼æç¤º DRY_RUN çŠ¶æ€"
dry_run_effective="$(get_env_value "DRY_RUN")"
if [[ -z "$dry_run_effective" ]]; then
  dry_run_effective="true"
fi
dry_run_lower="$(printf "%s" "$dry_run_effective" | tr '[:upper:]' '[:lower:]')"
case "$dry_run_lower" in
  false)
    echo "ğŸš¨ DRY_RUN = falseï¼ˆå®ç›˜æ¨¡å¼ï¼Œè°¨æ…æ“ä½œï¼‰"
    ;;
  *)
    echo "ğŸ›¡ï¸  DRY_RUN = ${dry_run_effective}ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰"
    ;;
esac
pass "DRY_RUN çŠ¶æ€å·²æ˜¾å¼è¾“å‡º"

echo

echo "[4/5] è¯­æ³•æ£€æŸ¥"
if python3 -m py_compile "$ROOT_DIR/auto_bot.py" >/dev/null 2>&1; then
  pass "auto_bot.py è¯­æ³•é€šè¿‡"
else
  fail "auto_bot.py è¯­æ³•å¤±è´¥"
fi

if node --check "$ROOT_DIR/bot.js" >/dev/null 2>&1; then
  pass "bot.js è¯­æ³•é€šè¿‡"
else
  fail "bot.js è¯­æ³•å¤±è´¥"
fi

echo

echo "[5/5] æ±‡æ€»"
echo "PASS: $pass_count | WARN: $warn_count | FAIL: $fail_count"

if [[ ${#warns[@]} -gt 0 ]]; then
  printf "\nè­¦å‘Šé¡¹ï¼š\n"
  for w in "${warns[@]}"; do
    echo "- $w"
  done
fi

if [[ ${#fails[@]} -gt 0 ]]; then
  printf "\nå¤±è´¥é¡¹ï¼š\n"
  for f in "${fails[@]}"; do
    echo "- $f"
  done
  printf "\nç»“æœï¼šâŒ è‡ªæ£€å¤±è´¥\n"
  exit 1
fi

printf "\nç»“æœï¼šâœ… è‡ªæ£€é€šè¿‡\n"
exit 0
